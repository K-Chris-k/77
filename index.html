<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ç²’å­è›‹ç³•æ•ˆæœ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #000; font-family: 'PingFang SC','Microsoft YaHei',sans-serif; }
        canvas { display: block; }

        /* === å¯åŠ¨é¡µ === */
        #start-page { position:fixed; inset:0; z-index:3000; background:radial-gradient(ellipse at center, #1a0a2e 0%, #0d0418 50%, #050210 100%); display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition:opacity 1s ease; }
        #start-page.fade-out { opacity:0; pointer-events:none; }
        .start-title { font-size:1.4rem; color:rgba(255,215,180,.7); letter-spacing:8px; margin-bottom:40px; text-shadow:0 0 20px rgba(255,200,100,.3); }
        .start-btn { width:120px; height:120px; border-radius:50%; border:2px solid rgba(255,200,150,.3); background:radial-gradient(circle, rgba(255,200,100,.15) 0%, transparent 70%); display:flex; align-items:center; justify-content:center; font-size:2.5rem; animation:startPulse 2s ease-in-out infinite; cursor:pointer; transition:all .3s ease; }
        .start-btn:hover { border-color:rgba(255,200,150,.6); background:radial-gradient(circle, rgba(255,200,100,.25) 0%, transparent 70%); transform:scale(1.08); box-shadow:0 0 40px rgba(255,200,100,.3); }
        @keyframes startPulse { 0%,100%{box-shadow:0 0 20px rgba(255,200,100,.15), 0 0 40px rgba(255,200,100,.05)} 50%{box-shadow:0 0 30px rgba(255,200,100,.3), 0 0 60px rgba(255,200,100,.1)} }
        .start-hint { margin-top:30px; font-size:.8rem; color:rgba(255,215,180,.35); letter-spacing:4px; animation:hintBlink 2s ease-in-out infinite; }
        @keyframes hintBlink { 0%,100%{opacity:.35} 50%{opacity:.7} }

        /* === å€’è®¡æ—¶é¡µ === */
        #countdown-page { position:fixed; inset:0; z-index:2000; background:#000; transition:opacity 1.5s ease; display:none; }
        #countdown-page.active { display:block; }
        #countdown-page.fade-out { opacity:0; pointer-events:none; }
        #countdown-canvas { position:absolute; inset:0; width:100%; height:100%; }

        /* === è›‹ç³•é¡µ === */
        #cake-page { display:none; }
        #cake-page.visible { display:block; }
        #title { position:absolute; top:20px; width:100%; text-align:center; pointer-events:none; z-index:10; }
        #title h1 { font-size:2.2rem; font-weight:400; letter-spacing:12px; color:#ffd700; text-shadow:0 0 30px rgba(255,215,0,.6),0 0 60px rgba(255,150,100,.3); font-variant:small-caps; }
        #controls { position:absolute; bottom:28px; width:100%; display:flex; justify-content:center; gap:12px; z-index:10; }
        .btn { padding:9px 22px; border:1px solid rgba(255,200,150,.4); background:rgba(255,180,100,.1); color:#ffd7a8; border-radius:30px; cursor:pointer; font-size:.82rem; letter-spacing:2px; backdrop-filter:blur(10px); transition:all .3s; font-family:inherit; }
        .btn:hover { background:rgba(255,180,100,.25); border-color:rgba(255,200,150,.7); box-shadow:0 0 20px rgba(255,180,100,.3); transform:translateY(-2px); }
        .btn.active { background:rgba(255,200,100,.3); border-color:#ffd700; box-shadow:0 0 25px rgba(255,200,100,.4); }

        /* === è®¸æ„¿å€’è®¡æ—¶ (é¡¶éƒ¨ï¼Œä¸æŒ¡è›‹ç³•) === */
        #wish-overlay { position:fixed; top:70px; left:0; right:0; z-index:50; display:flex; justify-content:center; pointer-events:none; opacity:0; transition:opacity .8s ease; }
        #wish-overlay.show { opacity:1; }
        #wish-overlay.hide { opacity:0; transition:opacity 1s ease; }
        #wish-box { display:flex; align-items:center; gap:20px; background:rgba(0,0,0,.45); backdrop-filter:blur(12px); border:1px solid rgba(255,200,150,.15); border-radius:50px; padding:12px 30px; }
        #wish-icon { font-size:1.6rem; animation:wishGlow 2s ease-in-out infinite; }
        @keyframes wishGlow { 0%,100%{filter:drop-shadow(0 0 6px rgba(255,200,100,.5))} 50%{filter:drop-shadow(0 0 18px rgba(255,200,100,.9))} }
        #wish-label { color:#ffd7a8; font-size:.95rem; letter-spacing:4px; text-shadow:0 0 15px rgba(255,200,100,.4); }
        #wish-ring-wrap { position:relative; width:52px; height:52px; }
        #wish-ring { width:52px; height:52px; transform:rotate(-90deg); }
        .ring-bg { fill:none; stroke:rgba(255,200,150,.12); stroke-width:3; }
        .ring-progress { fill:none; stroke:url(#ringGrad); stroke-width:3; stroke-linecap:round; stroke-dasharray:138.23; stroke-dashoffset:0; transition:stroke-dashoffset 1s linear; filter:drop-shadow(0 0 4px rgba(255,200,100,.5)); }
        #wish-sec { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:1.3rem; font-weight:300; color:#ffd700; text-shadow:0 0 12px rgba(255,215,0,.4); }

        /* === å¹ç­æç¤º === */
        #blow-text { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:60; font-size:1.8rem; color:#ffd700; letter-spacing:8px; text-shadow:0 0 30px rgba(255,215,0,.8),0 0 60px rgba(255,150,80,.4); opacity:0; pointer-events:none; transition:opacity .6s ease; }
        #blow-text.show { opacity:1; }
        #blow-text.fade { opacity:0; transition:opacity 1.5s ease; }

        /* === æ°”çƒ/æ¼‚æµ®ç‰©ç³»ç»Ÿ === */
        #balloon-layer { position:fixed; inset:0; z-index:40; pointer-events:none; overflow:hidden; display:none; }
        #balloon-layer.active { display:block; }
        .floater { position:absolute; cursor:pointer; pointer-events:auto; user-select:none; transition:transform .3s ease; filter:drop-shadow(0 4px 12px rgba(0,0,0,.4)); }
        .floater:hover { transform:scale(1.15) !important; filter:drop-shadow(0 6px 20px rgba(255,200,100,.5)); }
        /* å‰20ä¸ªçš„å¸å¼•åŠ¨ç”» */
        .floater.attract { animation:attract 1.2s ease-in-out infinite; }
        @keyframes attract { 0%,100%{transform:scale(1) rotate(0deg)} 25%{transform:scale(1.12) rotate(-3deg)} 50%{transform:scale(1.05) rotate(0deg)} 75%{transform:scale(1.12) rotate(3deg)} }
        /* ç‚¹å‡»æç¤ºæ ‡ç­¾ */
        .click-hint { position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); font-size:.6rem; color:#ffd700; white-space:nowrap; letter-spacing:1px; text-shadow:0 0 8px rgba(255,215,0,.6); animation:hintPulse 1.5s ease-in-out infinite; pointer-events:none; }
        @keyframes hintPulse { 0%,100%{opacity:.7; transform:translateX(-50%) scale(1)} 50%{opacity:1; transform:translateX(-50%) scale(1.08)} }

        /* === ç…§ç‰‡æµ®åŠ¨ç³»ç»Ÿ === */
        #photo-layer { position:fixed; inset:0; z-index:35; pointer-events:none; overflow:hidden; display:none; }
        #photo-layer.active { display:block; }
        .photo-floater { position:absolute; cursor:pointer; pointer-events:auto; border-radius:8px; overflow:hidden; box-shadow:0 4px 16px rgba(0,0,0,.5), 0 0 20px rgba(255,200,100,.15); border:2px solid rgba(255,200,150,.2); opacity:0; transition:opacity 1.2s ease, box-shadow .3s ease; }
        .photo-floater.visible { opacity:1; animation:photoFloat 3s ease-in-out infinite, photoPulse 2.5s ease-in-out infinite; }
        .photo-floater.fade-out { opacity:0; }
        .photo-floater:hover { box-shadow:0 6px 24px rgba(255,200,100,.5), 0 0 30px rgba(255,200,100,.3); }
        @keyframes photoPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
        @keyframes photoFloat { 0%,100%{translate:0 0} 25%{translate:3px -5px} 50%{translate:-2px 4px} 75%{translate:4px 2px} }
        .photo-floater img { width:100%; height:100%; object-fit:cover; display:block; }

        /* === ç…§ç‰‡æ”¾å¤§æŸ¥çœ‹ === */
        #photo-overlay { position:fixed; inset:0; z-index:200; background:rgba(0,0,0,.85); backdrop-filter:blur(12px); display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity .4s ease; cursor:pointer; }
        #photo-overlay.show { opacity:1; pointer-events:auto; }
        #photo-overlay img { max-width:90vw; max-height:85vh; border-radius:12px; box-shadow:0 0 60px rgba(255,200,100,.3); transition:transform .4s cubic-bezier(.34,1.56,.64,1); transform:scale(.7); }
        #photo-overlay.show img { transform:scale(1); }
        #photo-overlay-hint { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); color:rgba(255,255,255,.4); font-size:.8rem; letter-spacing:3px; }
        /* æ°”çƒSVG */
        .floater svg { width:100%; height:100%; }
        /* çˆ†ç‚¸ç²’å­ */
        .pop-particle { position:absolute; border-radius:50%; pointer-events:none; animation:popFly .8s ease-out forwards; }
        @keyframes popFly { 0%{opacity:1;transform:translate(0,0) scale(1)} 100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0)} }

        /* === ç¥ç¦å¼¹çª— === */
        #blessing-popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:100; opacity:0; pointer-events:none; transition:all .5s cubic-bezier(.34,1.56,.64,1); text-align:center; max-width:480px; }
        #blessing-popup.show { opacity:1; transform:translate(-50%,-50%) scale(1); }
        #blessing-popup.hide { opacity:0; transform:translate(-50%,-50%) scale(.8); }
        #blessing-card { background:rgba(15,5,30,.85); backdrop-filter:blur(20px); border:1px solid rgba(255,200,150,.2); border-radius:20px; padding:30px 40px; }
        #blessing-name { font-size:.85rem; color:rgba(255,200,150,.6); letter-spacing:3px; margin-bottom:12px; }
        #blessing-text { font-size:1.15rem; color:#ffe8cc; line-height:1.8; letter-spacing:2px; text-shadow:0 0 15px rgba(255,200,100,.3); }
        #blessing-close { margin-top:20px; font-size:.75rem; color:rgba(255,255,255,.3); letter-spacing:2px; }
    </style>
</head>
<body>

<svg style="position:absolute;width:0;height:0"><defs>
    <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" style="stop-color:#ffd700"/><stop offset="100%" style="stop-color:#ff8c42"/>
    </linearGradient>
</defs></svg>

<div id="blow-text">ğŸŒ¬ï¸ å‘¼ï½èœ¡çƒ›ç†„ç­äº†</div>

<!-- å¯åŠ¨é¡µ -->
<div id="start-page">
    <div class="start-title">ä¸ºä½ å‡†å¤‡äº†ä¸€ä»½æƒŠå–œ</div>
    <div class="start-btn">ğŸ</div>
    <div class="start-hint">â€” ç‚¹å‡»å¼€å¯ â€”</div>
</div>

<!-- å€’è®¡æ—¶é¡µ -->
<div id="countdown-page"><canvas id="countdown-canvas"></canvas></div>

<!-- è›‹ç³•é¡µ -->
<div id="cake-page">
    <div id="title"><h1>Happy Birthday</h1></div>

    <div id="wish-overlay">
        <div id="wish-box">
            <div id="wish-icon">ğŸ•¯ï¸</div>
            <div id="wish-label">é—­ä¸Šçœ¼ç›ï¼Œè®¸ä¸ªæ„¿å§</div>
            <div id="wish-ring-wrap">
                <svg id="wish-ring" viewBox="0 0 48 48">
                    <circle class="ring-bg" cx="24" cy="24" r="22"/>
                    <circle class="ring-progress" cx="24" cy="24" r="22"/>
                </svg>
                <span id="wish-sec">30</span>
            </div>
        </div>
    </div>

    <div id="balloon-layer"></div>
    <div id="photo-layer"></div>

    <div id="photo-overlay" onclick="closePhotoOverlay()">
        <img id="photo-overlay-img" src="" alt="photo"/>
        <div id="photo-overlay-hint">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
    </div>

    <div id="blessing-popup">
        <div id="blessing-card">
            <div id="blessing-name">â€”â€” è‡´ 77 â€”â€”</div>
            <div id="blessing-text"></div>
            <div id="blessing-close">ç‚¹å‡»ä»»æ„å¤„å…³é—­</div>
        </div>
    </div>

    <div id="controls">
        <button class="btn active" id="btnCake">ğŸ‚ è›‹ç³•å½¢æ€</button>
        <button class="btn" id="btnScatter">âœ¨ æ•£å¼€ç²’å­</button>
        <button class="btn" id="btnHeart">ğŸ’– çˆ±å¿ƒå½¢æ€</button>
        <button class="btn" id="btnCandle">ğŸ•¯ï¸ å¹èœ¡çƒ›</button>
    </div>
</div>

<!-- ============ å€’è®¡æ—¶è„šæœ¬ ============ -->
<script>
(function(){
    const canvas=document.getElementById('countdown-canvas'),ctx=canvas.getContext('2d');
    let W,H,cx,cy;
    function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight;cx=W/2;cy=H/2;}
    resize(); addEventListener('resize',resize);

    const SCENES=[
        {text:'10',dur:1100,fs:200},{text:'9',dur:1100,fs:200},{text:'8',dur:1100,fs:200},
        {text:'7',dur:1100,fs:200},{text:'6',dur:1100,fs:200},{text:'5',dur:1100,fs:200},
        {text:'4',dur:1100,fs:200},{text:'3',dur:1100,fs:200},{text:'2',dur:1100,fs:200},
        {text:'1',dur:1100,fs:200},
        {text:'ç”Ÿæ—¥å¿«ä¹',dur:3500,fs:120},
        {text:'æ„¿ä½ æ–°çš„ä¸€å²',dur:3500,fs:95},
        {text:'æ‰€æœ‰ç¾å¥½å¦‚æœŸè€Œè‡³',dur:3500,fs:85},
    ];
    let textParticles=[],bgStars=[],nebulaBlobs=[],sparkles=[],animId,t0=Date.now();

    // å€’è®¡æ—¶èƒŒæ™¯éŸ³ä¹
    const countdownBGM = new Audio();
    countdownBGM.preload = 'auto';
    countdownBGM.loop = true;
    countdownBGM.volume = 0.6;
    countdownBGM.src = 'https://cdn.shopify.com/s/files/1/0703/6289/0421/files/77_mp3cut.net.mp3?v=1770911535';
    countdownBGM.load(); // æå‰å¼€å§‹åŠ è½½
    let countdownBGMStarted = false;

    function playCountdownBGM(){
        const p = countdownBGM.play();
        if(p && p.then){
            p.then(()=>{ countdownBGMStarted=true; }).catch(function(err){
                console.warn('BGM play failed, retrying...', err);
                // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œç­‰éŸ³é¢‘åŠ è½½å¥½å†è¯•
                countdownBGM.addEventListener('canplaythrough', function retry(){
                    countdownBGM.removeEventListener('canplaythrough', retry);
                    countdownBGM.play().then(()=>{ countdownBGMStarted=true; }).catch(()=>{});
                }, {once:true});
            });
        }
    }
    function stopCountdownBGM(){
        countdownBGM.pause();
        countdownBGM.currentTime = 0;
        countdownBGMStarted = false;
    }
    function initBg(){
        for(let i=0;i<1200;i++) bgStars.push({x:Math.random()*W,y:Math.random()*H,r:.3+Math.random(),a:.15+Math.random()*.45,ph:Math.random()*6.28,sp:.008+Math.random()*.02,hue:Math.random()<.6?260+Math.random()*40:30+Math.random()*30,sat:60+Math.random()*40});
        const pal=[{h:270,s:60,l:30},{h:280,s:50,l:25},{h:35,s:70,l:35},{h:320,s:40,l:28},{h:250,s:55,l:22}];
        for(let i=0;i<12;i++){const c=pal[Math.random()*pal.length|0],a=Math.random()*6.28,d=100+Math.random()*Math.min(W,H)*.35;nebulaBlobs.push({x:cx+Math.cos(a)*d,y:cy+Math.sin(a)*d,rad:100+Math.random()*200,h:c.h,s:c.s,l:c.l,al:.04+Math.random()*.06,dx:(Math.random()-.5)*.15,dy:(Math.random()-.5)*.12,ph:Math.random()*6.28});}
    }
    function burst(n){for(let i=0;i<n;i++){const a=Math.random()*6.28,sp=1+Math.random()*4,h=Math.random()<.5?270+Math.random()*30:35+Math.random()*20;sparkles.push({x:cx+(Math.random()-.5)*80,y:cy+(Math.random()-.5)*80,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,dec:.008+Math.random()*.015,r:1+Math.random()*2,h,s:70+Math.random()*30,l:70+Math.random()*20});}}
    function sampleText(text,fs){const t=document.createElement('canvas'),c=t.getContext('2d');t.width=W;t.height=H;c.fillStyle='#000';c.fillRect(0,0,W,H);c.fillStyle='#fff';c.font=`bold ${fs}px "PingFang SC","Microsoft YaHei",sans-serif`;c.textAlign='center';c.textBaseline='middle';c.fillText(text,cx,cy);const d=c.getImageData(0,0,W,H).data,pts=[];for(let y=0;y<H;y+=6)for(let x=0;x<W;x+=6)if(d[(y*W+x)*4]>128)pts.push({x,y});return pts;}

    let si=-1;
    function next(){si++;if(si>=SCENES.length){stopCountdownBGM();setTimeout(()=>{document.getElementById('countdown-page').classList.add('fade-out');document.getElementById('cake-page').classList.add('visible');initCake();setTimeout(()=>{cancelAnimationFrame(animId);document.getElementById('countdown-page').style.display='none';},1800);},600);return;}
        const sc=SCENES[si],tgts=sampleText(sc.text,sc.fs);
        while(textParticles.length<tgts.length)textParticles.push({x:cx+(Math.random()-.5)*W*.8,y:cy+(Math.random()-.5)*H*.8,tx:0,ty:0,vx:0,vy:0,active:false,alpha:0,ho:(Math.random()-.5)*30,pp:Math.random()*6.28});
        for(let i=0;i<textParticles.length;i++){const p=textParticles[i];if(i<tgts.length){p.tx=tgts[i].x+(Math.random()-.5)*1.5;p.ty=tgts[i].y+(Math.random()-.5)*1.5;p.active=true;}else{const a=Math.random()*6.28,d=200+Math.random()*400;p.tx=cx+Math.cos(a)*d;p.ty=cy+Math.sin(a)*d;p.active=false;}}
        burst(60);setTimeout(next,sc.dur);
    }
    function render(){animId=requestAnimationFrame(render);const t=(Date.now()-t0)/1e3;ctx.globalCompositeOperation='source-over';ctx.fillStyle='rgba(5,2,15,.18)';ctx.fillRect(0,0,W,H);
        for(const n of nebulaBlobs){n.x+=n.dx+Math.sin(t*.3+n.ph)*.2;n.y+=n.dy+Math.cos(t*.25+n.ph)*.15;if(n.x<-n.rad)n.x=W+n.rad;if(n.x>W+n.rad)n.x=-n.rad;if(n.y<-n.rad)n.y=H+n.rad;if(n.y>H+n.rad)n.y=-n.rad;const p=n.al*(.8+.2*Math.sin(t*.8+n.ph)),g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.rad);g.addColorStop(0,`hsla(${n.h},${n.s}%,${n.l}%,${p})`);g.addColorStop(.6,`hsla(${n.h},${n.s}%,${n.l*.6}%,${p*.3})`);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.fillRect(n.x-n.rad,n.y-n.rad,n.rad*2,n.rad*2);}
        const gr=180+40*Math.sin(t*1.2),cg=ctx.createRadialGradient(cx,cy,0,cx,cy,gr);cg.addColorStop(0,`hsla(275,50%,40%,${.07+.03*Math.sin(t*1.8)})`);cg.addColorStop(.4,`hsla(40,60%,45%,${.03+.015*Math.sin(t*1.5)})`);cg.addColorStop(1,'transparent');ctx.fillStyle=cg;ctx.fillRect(0,0,W,H);
        for(const s of bgStars){s.ph+=s.sp;const a=s.a*(.4+.6*Math.sin(s.ph));if(a<.03)continue;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,6.28);ctx.fillStyle=`hsla(${s.hue},${s.sat}%,75%,${a})`;ctx.fill();}
        ctx.globalCompositeOperation='lighter';
        for(const p of textParticles){const dx=p.tx-p.x,dy=p.ty-p.y;p.vx+=dx*.06;p.vy+=dy*.06;p.vx*=.82;p.vy*=.82;p.x+=p.vx;p.y+=p.vy;const ta=p.active?1:0;p.alpha+=(ta-p.alpha)*.05;if(p.alpha<.01)continue;const dist=Math.sqrt(dx*dx+dy*dy),set=dist<8,pulse=set?.85+.15*Math.sin(t*3+p.pp):.5,dr=set?1.8:1.2+Math.min(dist*.01,1.5);if(set&&p.active){const gr2=dr*5,gg=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,gr2);gg.addColorStop(0,`hsla(${270+p.ho},50%,80%,${p.alpha*.15})`);gg.addColorStop(1,'transparent');ctx.fillStyle=gg;ctx.fillRect(p.x-gr2,p.y-gr2,gr2*2,gr2*2);}ctx.beginPath();ctx.arc(p.x,p.y,dr,0,6.28);const b=200+55*pulse|0;ctx.fillStyle=`rgba(${b},${b},${Math.min(255,b+30)},${p.alpha*pulse})`;ctx.fill();}
        sparkles=sparkles.filter(s=>s.life>0.01);for(const s of sparkles){s.x+=s.vx;s.y+=s.vy;s.vx*=.97;s.vy*=.97;s.life-=s.dec;if(s.life<=0)continue;const sr=Math.max(0.1,s.r*s.life);ctx.beginPath();ctx.arc(s.x,s.y,sr,0,6.28);ctx.fillStyle=`hsla(${s.h},${s.s}%,${s.l}%,${s.life*.8})`;ctx.fill();}
        ctx.globalCompositeOperation='source-over';
    }
    // ç­‰å¾…ç”¨æˆ·ç‚¹å‡»å¯åŠ¨é¡µåå†å¼€å§‹å€’è®¡æ—¶å’ŒéŸ³ä¹
    const startPage = document.getElementById('start-page');
    const countdownPage = document.getElementById('countdown-page');
    let launched = false;

    function launchCountdown(){
        if(launched) return; // é˜²æ­¢clickå’ŒtouchstartåŒé‡è§¦å‘
        launched = true;

        // ç”¨æˆ·å·²ç‚¹å‡»ï¼Œæµè§ˆå™¨å…è®¸æ’­æ”¾éŸ³é¢‘
        startPage.classList.add('fade-out');
        setTimeout(()=>{ startPage.style.display='none'; }, 1000);

        // æ˜¾ç¤ºå€’è®¡æ—¶é¡µé¢
        countdownPage.classList.add('active');

        // åˆå§‹åŒ–èƒŒæ™¯å’Œæ¸²æŸ“
        initBg();
        render();

        // ç«‹å³æ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼ˆæ­¤æ—¶å·²æœ‰ç”¨æˆ·äº¤äº’ï¼Œä¸ä¼šè¢«æµè§ˆå™¨æ‹¦æˆªï¼‰
        playCountdownBGM();

        // å»¶è¿Ÿ1ç§’åå¼€å§‹å€’è®¡æ—¶åœºæ™¯
        setTimeout(next, 1000);
    }

    startPage.addEventListener('click', launchCountdown);
    startPage.addEventListener('touchstart', launchCountdown, {passive:true});
})();
</script>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>

<script>
// ================================================================
//  è›‹ç³•ä¸»é¡µé¢
// ================================================================
let scene, camera, renderer, controls, composer, bloomPass;
let clock, allObjects=[], candleGroup, flameParticles=[], ambientGroup;
let currentMode='cake', candlesOn=true, transitionSpeed=.04;
const TOTAL=6000, CANDLE_NUM=5;

// ================================================================
//  50æ¡é«˜è´¨é‡ç¥ç¦è¯­
// ================================================================
const BLESSINGS = [
    "æ„¿ä½ çš„æ¯ä¸€å²éƒ½èƒ½å¥”èµ°åœ¨è‡ªå·±çš„çƒ­çˆ±é‡Œï¼Œä¸è¾œè´Ÿæ—¶é—´ï¼Œä¸å°†å°±ç”Ÿæ´»ã€‚",
    "å²æœˆå› ä½ è€Œæ˜äº®ï¼Œä¸–ç•Œå› ä½ è€Œæ¸©æš–ï¼Œç”Ÿæ—¥å¿«ä¹ï¼Œæ°¸è¿œæ˜¯å°‘å¹´æ¨¡æ ·ã€‚",
    "æ„¿ä½ æ‰€æ±‚çš†å¦‚æ„¿ï¼Œæ‰€è¡ŒåŒ–å¦é€”ï¼Œå¤šå–œä¹ï¼Œé•¿å®‰å®ã€‚",
    "å¸Œæœ›ä½ çš„å¿«ä¹æ˜¯å‘è‡ªå†…å¿ƒçš„ï¼Œè€Œä¸æ˜¯é åˆ«äººç»™äºˆçš„ã€‚",
    "æ„¿ä½ ç²¾è‡´åˆ°è€ï¼Œçœ¼é‡Œé•¿ç€å¤ªé˜³ï¼Œç¬‘é‡Œå…¨æ˜¯å¦è¡ã€‚",
    "æ„¿ä½ ä»¥æ¸ºå°å¯ç¨‹ï¼Œä»¥ä¼Ÿå¤§ç»“æŸï¼Œè¿™ä¸€è·¯æœ‰ç¹èŠ±ç›¸ä¼´ã€‚",
    "åœ¨æœ€å¥½çš„å¹´çºªï¼Œæ´»æˆè‡ªå·±æœ€æƒ³è¦çš„æ ·å­ã€‚ç”Ÿæ—¥å¿«ä¹ã€‚",
    "æ„¿ä½ çš„ä¸–ç•Œæ°¸è¿œå……æ»¡é˜³å…‰ï¼Œä¸å¿…å‡è£…ï¼Œå†…å¿ƒæ°¸è¿œå®‰ç„¶æ— æ™ã€‚",
    "å¾€åä½™ç”Ÿï¼Œæ„¿ä½ åªæœ‰å¿«ä¹ï¼Œæ²¡æœ‰æ‚²ä¼¤ï¼Œåªæœ‰ç¬‘å®¹ï¼Œæ²¡æœ‰æ³ªæ°´ã€‚",
    "æ„¿æ‰€æœ‰çš„åä¼šæœ‰æœŸï¼Œéƒ½æ˜¯å®ƒæ—¥çš„åˆ«æ¥æ— æ™ã€‚ç”Ÿæ—¥å¿«ä¹ã€‚",
    "æ„¿ç”Ÿæ´»ä¸å¤ªæ‹¥æŒ¤ï¼Œæ„¿ç¬‘å®¹ä¸å¿…åˆ»æ„ï¼Œæ„¿ä½ è¢«è¿™ä¸ªä¸–ç•Œæ¸©æŸ”ä»¥å¾…ã€‚",
    "æˆé•¿ä¸æœŸè€Œé‡ï¼Œç”Ÿæ—¥å¦‚æœŸè€Œè‡³ã€‚æ„¿æ—¶å…‰èƒ½ç¼“ï¼Œæ„¿æ•…äººä¸æ•£ã€‚",
    "æ„¿ä½ çœ¼ä¸­æœ‰æ˜Ÿè¾°ï¼Œèº«è¾¹æœ‰å¾®é£ï¼Œå¿ƒä¸­æœ‰æš–é˜³ï¼Œä¸€ç”Ÿè¢«çˆ±ã€‚",
    "å¸Œæœ›ä½ æ°¸è¿œæ²‰è¿·äºè¯»ä¹¦å’Œçƒ­çˆ±çš„äº‹ç‰©ä¸­ï¼Œä¸çŸ¥ç–²å€¦ï¼Œä¸çŸ¥è€ä¹‹å°†è‡³ã€‚",
    "æ„¿ä½ åœ¨å°˜ä¸–è·å¾—å¹¸ç¦ï¼Œæ„¿ä½ çš„çµé­‚æ°¸è¿œè‡ªç”±è€Œç‚½çƒ­ã€‚",
    "ä½ æ˜¯æ­¤é—´å°‘å¹´ï¼Œæœ€å¥½çš„å¹´çºªï¼Œä¸è¾œè´Ÿå…‰é˜´å°±æ˜¯æœ€å¥½çš„åŠªåŠ›ã€‚",
    "ç¥ä½ æœ‰å‰è¿›ä¸€å¯¸çš„å‹‡æ°”ï¼Œä¹Ÿæœ‰åé€€ä¸€å°ºçš„ä»å®¹ã€‚",
    "æ„¿ä½ ä¸€ç”ŸåŠªåŠ›ï¼Œä¸€ç”Ÿè¢«çˆ±ã€‚æƒ³è¦çš„éƒ½æ‹¥æœ‰ï¼Œå¾—ä¸åˆ°çš„éƒ½é‡Šæ€€ã€‚",
    "ä¸‡ç‰©æ›´æ–°ï¼Œæ—§ç–¾å½“æ„ˆï¼Œå¾€åçš„æ—¥å­é‡Œéƒ½æ˜¯å´­æ–°çš„ã€‚",
    "æ„¿ä½ çš„å–„è‰¯ç»ˆå°†è¢«æ¸©æŸ”ä»¥å¾…ï¼Œæ„¿ä½ çš„å‹‡æ•¢ç»ˆå°†ä¸è¢«è¾œè´Ÿã€‚",
    "ä½ æ˜¯æ˜Ÿè¾°çš„ç¬¬ä¸€é¡ºä½ç»§æ‰¿äººï¼Œç”Ÿæ—¥å¿«ä¹ï¼Œç»§ç»­é—ªè€€ã€‚",
    "æ„¿æ‰€æœ‰çš„ä¸å®‰éƒ½ä¼šæœ‰å›ç­”ï¼Œæ‰€æœ‰çš„ä»˜å‡ºéƒ½ä¼šæœ‰å›æŠ¥ã€‚",
    "å»è¿½é£å§ï¼Œè¿½åˆ°äº†å°±æ˜¯é£å’Œè‡ªç”±ï¼Œè¿½ä¸åˆ°ä¹Ÿæœ‰æ˜Ÿè¾°å¤§æµ·ã€‚",
    "æ„¿ä½ çœ¼çœ¸æœ‰æ˜Ÿè¾°ï¼Œå¿ƒä¸­æœ‰å±±æµ·ï¼Œä»æ­¤ä»¥æ¢¦ä¸ºé©¬ï¼Œä¸è´ŸéŸ¶åã€‚",
    "æ„¿ä½ ä»¥åçš„æ—¥å­é‡Œï¼Œæœ‰äººä¸ºä½ ç«‹é»„æ˜ï¼Œæœ‰äººé—®ä½ ç²¥å¯æ¸©ã€‚",
    "ä¸å¿µè¿‡å»ï¼Œä¸ç•å°†æ¥ï¼Œä¸è´Ÿå½“ä¸‹ã€‚ç”Ÿæ—¥å¿«ä¹ï¼Œæ–°å²å¤§å‰ã€‚",
    "ä½ å€¼å¾—ä¸–é—´æ‰€æœ‰çš„ç¾å¥½ï¼Œä¹Ÿç»ˆå°†é—ªè€€åœ¨è‡ªå·±çš„æ—¶åŒºé‡Œã€‚",
    "æ„¿ä½ å¦‚é˜³å…‰ï¼Œæ˜åªšä¸å¿§ä¼¤ã€‚æ„¿ä½ å¦‚æœˆå…‰ï¼Œæ¸©æŸ”ä¸”æ˜äº®ã€‚",
    "å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€ã€‚ç”Ÿå¦‚é€†æ—…ï¼Œä¸€è‹‡ä»¥èˆªã€‚ç”Ÿæ—¥å¿«ä¹ã€‚",
    "æ„¿ä½ æ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­æ³ªç›ˆçœ¶ï¼Œæ°¸è¿œç›¸ä¿¡ç¾å¥½çš„äº‹æƒ…å³å°†å‘ç”Ÿã€‚",
    "ä½™ç”Ÿå¾ˆé•¿ï¼Œåˆ«æ…Œå¼ ï¼Œä¸€åˆ‡éƒ½åœ¨å‘ä½ å¥”æ¥çš„è·¯ä¸Šã€‚",
    "æ—¶å…‰é™å¥½ï¼Œä¸å›è¯­ã€‚ç»†æ°´æµå¹´ï¼Œä¸å›åŒã€‚ç”Ÿæ—¥å¿«ä¹ã€‚",
    "æ„¿ä½ æ‰€åˆ°ä¹‹å¤„ï¼Œéåœ°é˜³å…‰ï¼›æ„¿ä½ æ¢¦çš„è¿œæ–¹ï¼Œæ¸©æš–ä¸ºå‘ã€‚",
    "å²å²å¸¸æ¬¢æ„‰ï¼Œå¹´å¹´çš†èƒœæ„ï¼Œä¸‡äº‹å°½å¯æœŸã€‚",
    "æ­¤åå¦‚ç«Ÿæ²¡æœ‰ç‚¬ç«ï¼Œä½ ä¾¿æ˜¯å”¯ä¸€çš„å…‰ã€‚ç”Ÿæ—¥å¿«ä¹ã€‚",
    "ä½ æ˜¯åˆ«äººç¿»äº†æ— æ•°é¡µä¹¦éƒ½æ‰¾ä¸åˆ°çš„ç­”æ¡ˆï¼Œç”Ÿæ—¥å¿«ä¹ã€‚",
    "å¸Œæœ›ä½ æ´»å¾—å°½å…´ï¼Œè€Œä¸æ˜¯è¿‡å¾—åº†å¹¸ã€‚",
    "æ„¿ä½ æœ‰ç›”ç”²ä¹Ÿæœ‰è½¯è‚‹ï¼Œå–„è‰¯å¾—æœ‰åŸåˆ™ï¼Œæ„Ÿæ€§å¾—æœ‰åº•çº¿ã€‚",
    "æˆ‘è¦åœ¨ä½ å¹³åº¸æ— å¥‡çš„å›å¿†é‡Œï¼Œåšä¸€ä¸ªé—ªé—ªå‘å…‰çš„ç¥ç»ç—…ã€‚ç”Ÿæ—¥å¿«ä¹ï¼",
    "è¸©ç€æ»¡åœ°çš„å…­ä¾¿å£«ï¼ŒæŠ¬å¤´çœ‹è§æœˆäº®ã€‚ç¥ä½ æ°¸è¿œæµªæ¼«ã€‚",
    "è¿™ä¸–é—´æ˜åªšçš„äº‹ç‰©é‚£ä¹ˆå¤šï¼Œè€Œä½ æ°å¥½æ˜¯æœ€æ˜åªšçš„é‚£ä¸€ä¸ªã€‚",
    "ä½ è¦æ‚„æ‚„æ‹”å°–ï¼Œç„¶åæƒŠè‰³æ‰€æœ‰äººã€‚ç”Ÿæ—¥å¿«ä¹ã€‚",
    "å‡¡æ˜¯è¿‡å¾€ï¼Œçš†ä¸ºåºç« ã€‚æ„¿æ–°çš„ä¸€å²ï¼Œä¸‡äº‹å¯æœŸã€‚",
    "æ„¿ä½ æ²‰å®šåˆæ‰§ç€ï¼Œå¯¹æ¯ä»¶çƒ­çˆ±çš„äº‹ç‰©éƒ½å…¨åŠ›ä»¥èµ´ã€‚",
    "æ„¿ä½ æœ‰éšå¤„å¯æ –çš„æ±Ÿæ¹–ï¼Œä¹Ÿæœ‰è¿½é£é€æ¢¦çš„éªå‹‡ã€‚",
    "åšè‡ªå·±çš„å¤ªé˜³ï¼Œæ— éœ€å‡­å€Ÿè°çš„å…‰ï¼Œä¾¿è‡ªæˆä¸€é“æ™¯è‰²ã€‚",
    "æ˜Ÿæ²³æ»šçƒ«ï¼Œä½ æ˜¯äººé—´ç†æƒ³ã€‚ç”Ÿæ—¥å¿«ä¹ï¼Œç»§ç»­ç¾å¥½ã€‚",
    "ä»Šå¤©çš„ä½ åˆé•¿å¤§äº†ä¸€å²ï¼Œä½†æ„¿ä½ çš„å¯çˆ±èƒ½æ²»æ„ˆä¸€åˆ‡ä¸å¯çˆ±ã€‚",
    "æ„¿ä½ çš„ç”Ÿæ´»æ—¢æœ‰å–„è‰¯ï¼Œåˆæœ‰é”‹èŠ’ã€‚æ—¢æœ‰æ¸©æƒ…ï¼Œåˆæœ‰åŠ›é‡ã€‚",
    "äººé—´å€¼å¾—ï¼Œæœªæ¥å¯æœŸï¼Œä½ æ°å¥½æ˜¯äººé—´æœ€å€¼å¾—æœŸå¾…çš„é£æ™¯ã€‚",
];
let blessingIndex = 0;

// ================================================================
//  è®¸æ„¿å€’è®¡æ—¶
// ================================================================
const WISH_DUR=30, RING_C=2*Math.PI*22;

function startWish(){
    const ov=document.getElementById('wish-overlay'),sec=document.getElementById('wish-sec'),ring=document.querySelector('.ring-progress');
    setTimeout(()=>{
        ov.classList.add('show');
        let left=WISH_DUR;
        sec.textContent=left;
        ring.style.strokeDashoffset='0';
        const iv=setInterval(()=>{
            left--;if(left<0)left=0;
            sec.textContent=left;
            ring.style.strokeDashoffset=((1-left/WISH_DUR)*RING_C).toFixed(1);
            if(left<=5&&left>0){sec.style.color='#ff6b4a';sec.style.textShadow='0 0 20px rgba(255,100,60,.8)';}
            if(left<=0){clearInterval(iv);blowOut();}
        },1000);
    },3000);
}

function blowOut(){
    document.getElementById('wish-overlay').classList.remove('show');
    document.getElementById('wish-overlay').classList.add('hide');
    playBlowSound();
    const bt=document.getElementById('blow-text');
    setTimeout(()=>bt.classList.add('show'),300);
    setTimeout(()=>{candlesOn=false;document.getElementById('btnCandle').textContent='ğŸ”¥ ç‚¹èœ¡çƒ›';document.getElementById('btnCandle').classList.add('active');},800);
    setTimeout(()=>{bt.classList.remove('show');bt.classList.add('fade');switchMode('scatter');},3000);
    setTimeout(()=>bt.classList.remove('fade'),5000);
}

function playBlowSound(){
    try{const a=new(window.AudioContext||window.webkitAudioContext)(),dur=1.5,sr=a.sampleRate,sz=sr*dur,buf=a.createBuffer(1,sz,sr),d=buf.getChannelData(0);for(let i=0;i<sz;i++){const t=i/sr,env=Math.min(t/.08,1)*Math.exp(-t*2.5);d[i]=((Math.random()*2-1)*.6+Math.sin(t*80)*.3)*env*.5;}const s=a.createBufferSource();s.buffer=buf;const f=a.createBiquadFilter();f.type='lowpass';f.frequency.setValueAtTime(2000,a.currentTime);f.frequency.exponentialRampToValueAtTime(400,a.currentTime+dur);const g=a.createGain();g.gain.setValueAtTime(.6,a.currentTime);g.gain.exponentialRampToValueAtTime(.01,a.currentTime+dur);s.connect(f);f.connect(g);g.connect(a.destination);s.start();s.onended=()=>a.close();}catch(e){}
}

// ================================================================
//  æ°”çƒ/æ¼‚æµ®ç‰©ç³»ç»Ÿ
// ================================================================
let floaterCount=0, floaterTimer=null, balloonActive=false;

const SHAPES = ['balloon','heart','moon','star','balloon','heart','balloon','star','balloon','heart'];
const FLOAT_COLORS = [
    ['#ff6b9d','#ff4081'],['#ffd740','#ffab00'],['#69f0ae','#00c853'],
    ['#40c4ff','#0091ea'],['#ea80fc','#aa00ff'],['#ff8a80','#ff1744'],
    ['#b388ff','#651fff'],['#84ffff','#00e5ff'],['#ffab91','#ff3d00'],
    ['#f48fb1','#e91e63'],['#ce93d8','#9c27b0'],['#81d4fa','#039be5'],
];

function makeBalloonSVG(shape, c1, c2, size){
    const s = size;
    if(shape==='balloon'){
        return `<svg viewBox="0 0 80 120" width="${s}" height="${s*1.5}">
            <defs><radialGradient id="bg${floaterCount}" cx="35%" cy="30%"><stop offset="0%" stop-color="${c1}" stop-opacity=".9"/><stop offset="100%" stop-color="${c2}"/></radialGradient></defs>
            <ellipse cx="40" cy="45" rx="32" ry="40" fill="url(#bg${floaterCount})"/>
            <ellipse cx="40" cy="45" rx="32" ry="40" fill="rgba(255,255,255,.15)" clip-path="inset(0 50% 50% 0)"/>
            <polygon points="40,85 36,92 44,92" fill="${c2}"/>
            <line x1="40" y1="92" x2="40" y2="118" stroke="rgba(255,255,255,.4)" stroke-width="1"/>
            <ellipse cx="30" cy="32" rx="6" ry="8" fill="rgba(255,255,255,.25)" transform="rotate(-20,30,32)"/>
        </svg>`;
    } else if(shape==='heart'){
        return `<svg viewBox="0 0 100 100" width="${s}" height="${s}">
            <defs><radialGradient id="bg${floaterCount}" cx="40%" cy="35%"><stop offset="0%" stop-color="${c1}" stop-opacity=".9"/><stop offset="100%" stop-color="${c2}"/></radialGradient></defs>
            <path d="M50 88 C25 65 5 50 5 30 A22 22 0 0 1 50 30 A22 22 0 0 1 95 30 C95 50 75 65 50 88Z" fill="url(#bg${floaterCount})"/>
            <ellipse cx="30" cy="30" rx="8" ry="6" fill="rgba(255,255,255,.2)" transform="rotate(-30,30,30)"/>
        </svg>`;
    } else if(shape==='moon'){
        return `<svg viewBox="0 0 80 80" width="${s}" height="${s}">
            <defs><radialGradient id="bg${floaterCount}" cx="40%" cy="35%"><stop offset="0%" stop-color="${c1}"/><stop offset="100%" stop-color="${c2}"/></radialGradient></defs>
            <circle cx="40" cy="40" r="30" fill="url(#bg${floaterCount})"/>
            <circle cx="52" cy="32" r="24" fill="rgba(0,0,0,.85)"/>
            <circle cx="30" cy="28" rx="3" ry="2" r="3" fill="rgba(255,255,255,.2)"/>
        </svg>`;
    } else { // star
        return `<svg viewBox="0 0 100 100" width="${s}" height="${s}">
            <defs><radialGradient id="bg${floaterCount}" cx="40%" cy="35%"><stop offset="0%" stop-color="${c1}"/><stop offset="100%" stop-color="${c2}"/></radialGradient></defs>
            <polygon points="50,5 61,38 95,38 67,59 78,93 50,72 22,93 33,59 5,38 39,38" fill="url(#bg${floaterCount})"/>
            <polygon points="50,15 58,38 80,38 62,52 70,78 50,62 30,78 38,52 20,38 42,38" fill="rgba(255,255,255,.12)"/>
        </svg>`;
    }
}

function spawnFloater(){
    if(!balloonActive) return;
    const layer = document.getElementById('balloon-layer');
    const side = Math.random() < 0.5 ? 'left' : 'right';
    const x = side==='left' ? 30+Math.random()*120 : innerWidth-150+Math.random()*120;
    const shape = SHAPES[Math.floor(Math.random()*SHAPES.length)];
    const colors = FLOAT_COLORS[Math.floor(Math.random()*FLOAT_COLORS.length)];
    const size = 50 + Math.random()*30;
    const dur = 8+Math.random()*6; // ä¸Šæµ®æ—¶é—´
    const sway = 20+Math.random()*40; // æ¨ªå‘æ‘†åŠ¨å¹…åº¦

    const el = document.createElement('div');
    el.className = 'floater';
    el.innerHTML = makeBalloonSVG(shape, colors[0], colors[1], size);
    el.style.left = x + 'px';
    el.style.bottom = '-150px';
    el.style.width = size + 'px';

    // å‰20ä¸ªæœ‰å¸å¼•åŠ¨ç”»+ç‚¹å‡»æç¤º
    floaterCount++;
    if(floaterCount <= 20) {
        el.classList.add('attract');
        const hint = document.createElement('span');
        hint.className = 'click-hint';
        hint.textContent = 'ç‚¹å‡»æˆ‘~';
        el.appendChild(hint);
    }

    // ä¸Šæµ®åŠ¨ç”»
    const startTime = Date.now();
    const startX = x;
    let popped = false;

    function floatUp(){
        if(popped) return;
        const elapsed = (Date.now()-startTime)/1000;
        const progress = elapsed/dur;
        if(progress >= 1){ el.remove(); return; }
        const yy = -150 + progress * (innerHeight + 300);
        const xx = startX + Math.sin(elapsed * 1.2) * sway;
        const rot = Math.sin(elapsed * 0.8) * 8;
        el.style.bottom = (-150 + yy) + 'px';
        el.style.left = xx + 'px';
        el.style.transform = `rotate(${rot}deg)`;
        requestAnimationFrame(floatUp);
    }

    el.addEventListener('click', (e) => {
        e.stopPropagation();
        if(popped) return;
        popped = true;
        popFloater(el, colors[0]);
    });

    layer.appendChild(el);
    requestAnimationFrame(floatUp);
}

function popFloater(el, color){
    playPopSound();
    const rect = el.getBoundingClientRect();
    const cx = rect.left + rect.width/2;
    const cy = rect.top + rect.height/2;

    // çˆ†ç‚¸ç²’å­
    const layer = document.getElementById('balloon-layer');
    for(let i=0;i<16;i++){
        const p = document.createElement('div');
        p.className='pop-particle';
        const angle = (i/16)*Math.PI*2;
        const dist = 40+Math.random()*60;
        p.style.cssText = `left:${cx}px;top:${cy}px;width:${4+Math.random()*6}px;height:${4+Math.random()*6}px;background:${color};--dx:${Math.cos(angle)*dist}px;--dy:${Math.sin(angle)*dist}px;`;
        layer.appendChild(p);
        setTimeout(()=>p.remove(),800);
    }

    el.remove();
    showBlessing();
}

function playPopSound(){
    try{const a=new(window.AudioContext||window.webkitAudioContext)(),dur=.3,sr=a.sampleRate,sz=sr*dur,buf=a.createBuffer(1,sz,sr),d=buf.getChannelData(0);for(let i=0;i<sz;i++){const t=i/sr;d[i]=(Math.random()*2-1)*Math.exp(-t*20)*.8;}const s=a.createBufferSource();s.buffer=buf;const f=a.createBiquadFilter();f.type='bandpass';f.frequency.value=800;f.Q.value=1;const g=a.createGain();g.gain.setValueAtTime(.5,a.currentTime);s.connect(f);f.connect(g);g.connect(a.destination);s.start();s.onended=()=>a.close();}catch(e){}
}

function showBlessing(){
    const popup = document.getElementById('blessing-popup');
    const textEl = document.getElementById('blessing-text');
    textEl.textContent = BLESSINGS[blessingIndex % BLESSINGS.length];
    blessingIndex++;
    popup.classList.remove('hide');
    popup.classList.add('show');
    const close = ()=>{ popup.classList.remove('show'); popup.classList.add('hide'); document.removeEventListener('click', close); };
    setTimeout(()=> document.addEventListener('click', close), 300);
    // è‡ªåŠ¨å…³é—­
    setTimeout(()=>{ popup.classList.remove('show'); popup.classList.add('hide'); }, 5000);
}

function startBalloons(){
    if(balloonActive) return;
    balloonActive = true;
    document.getElementById('balloon-layer').classList.add('active');
    floaterCount = 0;
    // ä¸€æ¬¡ä¸Šæµ®ä¸€ä¸ªï¼Œé—´éš”2-4ç§’
    function next(){
        if(!balloonActive) return;
        spawnFloater();
        floaterTimer = setTimeout(next, 2000+Math.random()*2000);
    }
    next();
}

function stopBalloons(){
    balloonActive = false;
    clearTimeout(floaterTimer);
    document.getElementById('balloon-layer').classList.remove('active');
}

// ================================================================
//  Three.js è›‹ç³•
// ================================================================
function initCake(){
    clock=new THREE.Clock();
    scene=new THREE.Scene();scene.background=new THREE.Color(0);
    camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,.1,500);camera.position.set(0,12,22);
    renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1;renderer.shadowMap.enabled=true;document.body.appendChild(renderer.domElement);
    controls=new THREE.OrbitControls(camera,renderer.domElement);controls.enableDamping=true;controls.dampingFactor=.05;controls.target.set(0,4,0);controls.minDistance=10;controls.maxDistance=40;controls.maxPolarAngle=Math.PI*.85;
    setupLights();createCakeParticles();createCandles();createAmbientParticles();setupPostProcessing();setupEvents();animateCake();
    startWish();
    startBirthdayMusic();
}

function setupLights(){
    scene.add(new THREE.AmbientLight(0xffeedd,.5));
    let k=new THREE.PointLight(0xffd080,2.5,60);k.position.set(8,18,10);k.castShadow=true;scene.add(k);
    let f=new THREE.PointLight(0xff8899,1.2,50);f.position.set(-10,8,-6);scene.add(f);
    let r=new THREE.PointLight(0x8888ff,.8,40);r.position.set(0,-3,-12);scene.add(r);
    let t=new THREE.DirectionalLight(0xffffff,.4);t.position.set(0,25,0);scene.add(t);
    let c=new THREE.PointLight(0xffaa33,2,15);c.position.set(0,10,0);scene.add(c);
}

function createCakeParticles(){
    const sG = new THREE.SphereGeometry(1,8,6);
    const bG = new THREE.BoxGeometry(1,1,1);
    const cG = new THREE.CylinderGeometry(.5,.5,1,8);
    // é”¥å½¢å‡ ä½•ä½“ - ç”¨äºè‰è“çš„å¶å­
    const coneG = new THREE.ConeGeometry(.5,1,6);

    // ==================== å››å±‚è›‹ç³•å®šä¹‰ ====================
    // åº•å±‚åšå®ã€ä¸­é—´å±‚é€’å‡ã€é¡¶å±‚ç²¾è‡´å°å·§
    const layers = [
        { rMax: 6.0, yMin: 0,    yMax: 2.2,  cnt: 0.28 },  // ç¬¬1å±‚ - åº•å±‚ (å·§å…‹åŠ›)
        { rMax: 4.8, yMin: 2.2,  yMax: 4.0,  cnt: 0.22 },  // ç¬¬2å±‚ (é¦™è‰å¥¶æ²¹)
        { rMax: 3.6, yMin: 4.0,  yMax: 5.5,  cnt: 0.18 },  // ç¬¬3å±‚ (è‰è“ç²‰)
        { rMax: 2.4, yMin: 5.5,  yMax: 6.8,  cnt: 0.12 },  // ç¬¬4å±‚ - é¡¶å±‚ (å¥¶æ²¹ç™½)
    ];

    // æ¯å±‚å¥¶æ²¹è¾¹
    const frostings = [
        { r: 6.0,  y: 2.2,  cnt: 0.025 },
        { r: 4.8,  y: 4.0,  cnt: 0.02 },
        { r: 3.6,  y: 5.5,  cnt: 0.02 },
        { r: 2.4,  y: 6.8,  cnt: 0.02 },
    ];

    // å››å±‚é…è‰² - ä»æ·±åˆ°æµ…ï¼Œæ¨¡æ‹ŸçœŸå®è›‹ç³•åˆ†å±‚
    const layerColors = [
        [0x8B5E3C, 0x7A5230, 0x9B6B45, 0xA07048, 0x6B4226],  // å·§å…‹åŠ›æ£•
        [0xF5DEB3, 0xEED9A0, 0xFAE6B0, 0xE8D098, 0xF0D8A8],  // é¦™è‰é»„
        [0xFF8FA0, 0xFF7088, 0xFFA0B0, 0xE86880, 0xF07898],  // è‰è“ç²‰
        [0xFFF5EE, 0xFFEDE0, 0xFFF0E8, 0xFFE8D8, 0xFFF8F0],  // å¥¶æ²¹ç™½
    ];

    const frostColor = [0xFFFAF0, 0xFFFFF0, 0xFFFDE0, 0xFFF5D0, 0xFFFFFF];
    const plateColor = [0xE8E8E8, 0xD8D8D8, 0xF0F0F0, 0xC8C8C8];

    // ==================== è›‹ç³•ä¸»ä½“ ====================
    for (let l = 0; l < layers.length; l++) {
        const la = layers[l];
        const n = TOTAL * la.cnt | 0;
        const cs = layerColors[l];
        for (let i = 0; i < n; i++) {
            const a = Math.random() * 6.28;
            const r = Math.sqrt(Math.random()) * la.rMax;
            const y = la.yMin + Math.random() * (la.yMax - la.yMin);
            const pos = new THREE.Vector3(Math.cos(a)*r, y, Math.sin(a)*r);
            const col = cs[Math.random()*cs.length|0];
            const t = Math.random();
            let geo, sc;
            if (t < 0.5)      { geo = sG; sc = 0.12 + Math.random()*0.16; }
            else if (t < 0.85) { geo = bG; sc = 0.10 + Math.random()*0.12; }
            else               { geo = cG; sc = 0.08 + Math.random()*0.10; }
            addP(geo, pos, sc, col, l);
        }
    }

    // ==================== å¥¶æ²¹å±‚è¾¹ç¼˜ + æ»´è½ ====================
    for (let f = 0; f < frostings.length; f++) {
        const fr = frostings[f];
        const n = TOTAL * fr.cnt | 0;
        // è¾¹ç¼˜æ³¢æµª
        for (let i = 0; i < n; i++) {
            const a = (i/n)*6.28 + Math.random()*0.3;
            const wave = Math.sin(a*10)*0.3;
            const rr = fr.r + wave + (Math.random()-0.5)*0.2;
            const yy = fr.y + (Math.random()-0.5)*0.3;
            addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
                 0.1+Math.random()*0.12, frostColor[Math.random()*frostColor.length|0], 10);
        }
        // å¥¶æ²¹æ»´è½
        const drips = 14;
        for (let d = 0; d < drips; d++) {
            const a = (d/drips)*6.28 + Math.random()*0.3;
            const dripLen = 0.3 + Math.random()*0.9;
            const pts = 3 + (Math.random()*4|0);
            for (let p = 0; p < pts; p++) {
                const t = p/pts;
                const rr = fr.r + Math.sin(a*10)*0.2;
                addP(sG, new THREE.Vector3(Math.cos(a)*rr, fr.y - t*dripLen, Math.sin(a)*rr),
                     0.07 + (1-t)*0.07, frostColor[Math.random()*frostColor.length|0], 10);
            }
        }
    }

    // ==================== æ°´æœè£…é¥° ====================
    // è‰è“ - çº¢è‰²çƒ + ç»¿è‰²å°é”¥ä½“å¶å­
    const strawberryCount = 35;
    for (let i = 0; i < strawberryCount; i++) {
        const layerIdx = Math.random()*4|0;
        const la = layers[layerIdx];
        const a = Math.random()*6.28;
        const rr = la.rMax * (0.5 + Math.random()*0.5);
        const yy = la.yMax + 0.05;
        // è‰è“æœå®
        const strawCol = [0xCC1100, 0xDD2211, 0xBB0000, 0xEE3322][Math.random()*4|0];
        addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.22 + Math.random()*0.1, strawCol, 20);
        // è‰è“ä¸Šçš„å°äº®ç‚¹(ç§å­)
        for (let s = 0; s < 3; s++) {
            const oa = a + (Math.random()-0.5)*0.15;
            const or = rr + (Math.random()-0.5)*0.1;
            addP(sG, new THREE.Vector3(Math.cos(oa)*or, yy + (Math.random()-0.5)*0.1, Math.sin(oa)*or),
                 0.04, 0xFFDD44, 20);
        }
        // å¶å­
        addP(coneG, new THREE.Vector3(Math.cos(a)*rr, yy + 0.2, Math.sin(a)*rr),
             0.1, 0x228B22, 21);
    }

    // è“è“ - æ·±è“/ç´«è‰²å°çƒ
    const blueberryCount = 40;
    for (let i = 0; i < blueberryCount; i++) {
        const layerIdx = Math.random()*4|0;
        const la = layers[layerIdx];
        const a = Math.random()*6.28;
        const rr = la.rMax * (0.3 + Math.random()*0.7);
        const yy = la.yMax + 0.02;
        const bbCol = [0x2E1A6B, 0x3D2B80, 0x4B3A8F, 0x1E0A5B][Math.random()*4|0];
        addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.14 + Math.random()*0.06, bbCol, 22);
        // è“è“é¡¶éƒ¨æµ…è‰²ç‚¹
        addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy + 0.1, Math.sin(a)*rr),
             0.04, 0x8888CC, 22);
    }

    // æ©™å­/æŸ‘æ©˜ç‰‡ - æ©™è‰²æ‰åœ†
    const orangeCount = 20;
    for (let i = 0; i < orangeCount; i++) {
        const layerIdx = Math.random()*4|0;
        const la = layers[layerIdx];
        const a = Math.random()*6.28;
        const rr = la.rMax * (0.4 + Math.random()*0.6);
        const yy = la.yMax + 0.03;
        const orCol = [0xFF8C00, 0xFFA500, 0xFFAA22, 0xFF9911][Math.random()*4|0];
        addP(cG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.18 + Math.random()*0.08, orCol, 23);
        // æœè‚‰çº¹ç†äº®ç‚¹
        addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy + 0.05, Math.sin(a)*rr),
             0.06, 0xFFDD88, 23);
    }

    // çŒ•çŒ´æ¡ƒç‰‡ - ç»¿è‰²
    const kiwiCount = 15;
    for (let i = 0; i < kiwiCount; i++) {
        const layerIdx = Math.random()*4|0;
        const la = layers[layerIdx];
        const a = Math.random()*6.28;
        const rr = la.rMax * (0.5 + Math.random()*0.5);
        const yy = la.yMax + 0.02;
        addP(cG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.16 + Math.random()*0.06, [0x6BAA2E, 0x7EC850, 0x88CC44][Math.random()*3|0], 24);
        // çŒ•çŒ´æ¡ƒç±½
        for (let s = 0; s < 4; s++) {
            const oa = a + (Math.random()-0.5)*0.12;
            const or = rr + (Math.random()-0.5)*0.08;
            addP(sG, new THREE.Vector3(Math.cos(oa)*or, yy + 0.03, Math.sin(oa)*or),
                 0.025, 0x111111, 24);
        }
    }

    // é¡¶éƒ¨å¤§è‰è“ï¼ˆè›‹ç³•é¡¶ç«¯ä¸­å¿ƒè£…é¥°ï¼‰
    for (let i = 0; i < 5; i++) {
        const a = (i/5)*6.28;
        const rr = 0.8;
        const yy = 6.85;
        addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.28 + Math.random()*0.08, [0xCC1100,0xDD2211][Math.random()*2|0], 20);
        addP(coneG, new THREE.Vector3(Math.cos(a)*rr, yy+0.25, Math.sin(a)*rr),
             0.12, 0x228B22, 21);
    }

    // ==================== å½©è‰²è£…é¥°ç³–ç  ====================
    const decoColors = [0xFF3355, 0xFFD700, 0x44DD88, 0x4488FF, 0xFF66AA, 0xFFAA00, 0xCC44FF, 0x00DDCC];
    const dn = TOTAL * 0.02 | 0;
    for (let i = 0; i < dn; i++) {
        const l = Math.random()*4|0;
        const la = layers[l];
        const a = Math.random()*6.28;
        const rr = la.rMax * (0.3 + Math.random()*0.7);
        const yy = la.yMin + Math.random()*(la.yMax - la.yMin);
        addP(sG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.08 + Math.random()*0.08, decoColors[Math.random()*decoColors.length|0], 4);
    }

    // ==================== å·§å…‹åŠ›ç¢ç‰‡ï¼ˆä¾§é¢è£…é¥°ï¼‰====================
    const chocoCount = 60;
    for (let i = 0; i < chocoCount; i++) {
        const l = Math.random()*4|0;
        const la = layers[l];
        const a = Math.random()*6.28;
        const rr = la.rMax * (0.85 + Math.random()*0.15); // é è¿‘è¾¹ç¼˜
        const yy = la.yMin + Math.random()*(la.yMax - la.yMin);
        const chocoCol = [0x3C1A00, 0x4A2200, 0x5C2E10, 0x6B3A1A][Math.random()*4|0];
        addP(bG, new THREE.Vector3(Math.cos(a)*rr, yy, Math.sin(a)*rr),
             0.06 + Math.random()*0.06, chocoCol, 25);
    }

    // ==================== åº•ç›˜ ====================
    const pn = TOTAL * 0.04 | 0;
    for (let i = 0; i < pn; i++) {
        const a = Math.random()*6.28;
        const r = 6.0 + Math.random()*2.0;
        addP(bG, new THREE.Vector3(Math.cos(a)*r, -0.1+Math.random()*0.12, Math.sin(a)*r),
             0.08+Math.random()*0.06, plateColor[Math.random()*plateColor.length|0], 5);
    }
}

function addP(geo,cp,sc,col,lt){
    // ä¸åŒç±»å‹ä¸åŒæè´¨
    let roughness = 0.4, metalness = 0.5, emissiveI = 0.1;
    if (lt === 4)  { roughness=0.15; metalness=0.85; emissiveI=0.3; }   // ç³–ç  - é‡‘å±å…‰æ³½
    if (lt === 10) { roughness=0.2;  metalness=0.1;  emissiveI=0.15; }  // å¥¶æ²¹
    if (lt === 20) { roughness=0.6;  metalness=0.05; emissiveI=0.08; }  // è‰è“
    if (lt === 21) { roughness=0.7;  metalness=0.0;  emissiveI=0.05; }  // å¶å­
    if (lt === 22) { roughness=0.3;  metalness=0.2;  emissiveI=0.1; }   // è“è“ - å¾®å…‰æ³½
    if (lt === 23) { roughness=0.5;  metalness=0.05; emissiveI=0.12; }  // æ©™å­ - æ¹¿æ¶¦æ„Ÿ
    if (lt === 24) { roughness=0.5;  metalness=0.0;  emissiveI=0.1; }   // çŒ•çŒ´æ¡ƒ
    if (lt === 25) { roughness=0.3;  metalness=0.3;  emissiveI=0.05; }  // å·§å…‹åŠ›
    if (lt === 5)  { roughness=0.2;  metalness=0.6;  emissiveI=0.05; }  // ç›˜å­
    const m=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color:col,roughness,metalness,emissive:col,emissiveIntensity:emissiveI}));
    m.scale.setScalar(sc);
    const th=Math.random()*6.28,ph=Math.acos(2*Math.random()-1),sr=6+Math.random()*14;
    const sp=new THREE.Vector3(sr*Math.sin(ph)*Math.cos(th),sr*Math.sin(ph)*Math.sin(th)+5,sr*Math.cos(ph));
    const ht=Math.random()*6.28,hs=Math.random()*Math.PI,hc=.38,hf=.3+Math.random()*.7;
    const hp=new THREE.Vector3(hc*16*Math.pow(Math.sin(ht),3)*Math.sin(hs)*hf,(hc*(13*Math.cos(ht)-5*Math.cos(2*ht)-2*Math.cos(3*ht)-Math.cos(4*ht))+7)*hf+(1-hf)*5,hc*16*Math.pow(Math.sin(ht),3)*Math.cos(hs)*hf);
    m.position.set(cp.x+(Math.random()-.5)*8,cp.y+12+Math.random()*18,cp.z+(Math.random()-.5)*8);
    m.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
    scene.add(m);
    allObjects.push({mesh:m,cakePos:cp.clone(),scatterPos:sp,heartPos:hp,currentTarget:cp.clone(),rs:new THREE.Vector3((Math.random()-.5)*.02,(Math.random()-.5)*.02,(Math.random()-.5)*.02),bs:sc,lt});
}

function createCandles(){
    candleGroup=new THREE.Group();
    const topY=6.8, cr=1.4;
    for(let c=0; c<CANDLE_NUM; c++){
        const a=(c/CANDLE_NUM)*6.28+.2;
        const cx=Math.cos(a)*cr, cz=Math.sin(a)*cr;

        // èœ¡çƒ›æŸ±
        const candle=new THREE.Mesh(
            new THREE.CylinderGeometry(.1,.1,1.5,8),
            new THREE.MeshStandardMaterial({color:0xfff8e8,roughness:.6,metalness:.1,emissive:0xfff0d0,emissiveIntensity:.1})
        );
        candle.position.set(cx, topY+.75, cz);
        candleGroup.add(candle);

        // ç¯èŠ¯
        const wick=new THREE.Mesh(
            new THREE.CylinderGeometry(.015,.015,.2,4),
            new THREE.MeshBasicMaterial({color:0x333333})
        );
        wick.position.set(cx, topY+1.6, cz);
        candleGroup.add(wick);

        // ç«ç„°
        const fc=[0xffdd22,0xffaa00,0xff6600,0xffffaa,0xffcc44];
        for(let f=0;f<12;f++){
            const fm=new THREE.Mesh(
                new THREE.SphereGeometry(.06+Math.random()*.08,6,4),
                new THREE.MeshBasicMaterial({color:fc[Math.random()*fc.length|0],transparent:true,opacity:.85})
            );
            fm.position.set(cx+(Math.random()-.5)*.1, topY+1.65+Math.random()*.35, cz+(Math.random()-.5)*.1);
            candleGroup.add(fm);
            flameParticles.push({mesh:fm,bx:cx,bz:cz,by:topY+1.65,sp:.5+Math.random()*1.5,of:Math.random()*6.28,mh:.3+Math.random()*.2});
        }

        // ç«ç„°å…‰æº
        const fl=new THREE.PointLight(0xff8833,.6,5);
        fl.position.set(cx, topY+1.8, cz);
        candleGroup.add(fl);
    }
    scene.add(candleGroup);
}

function createAmbientParticles(){
    ambientGroup=new THREE.Group();const cs=[0xffd700,0xff88aa,0xffffff,0xffcc88,0xaaddff];
    for(let i=0;i<300;i++){const m=new THREE.Mesh(new THREE.SphereGeometry(.03+Math.random()*.05,4,3),new THREE.MeshBasicMaterial({color:cs[Math.random()*cs.length|0],transparent:true,opacity:.3+Math.random()*.5}));m.position.set((Math.random()-.5)*35,Math.random()*22-2,(Math.random()-.5)*35);m.userData={sp:.2+Math.random()*.6,of:Math.random()*6.28,by:m.position.y};ambientGroup.add(m);}
    scene.add(ambientGroup);
}

function setupPostProcessing(){composer=new THREE.EffectComposer(renderer);composer.addPass(new THREE.RenderPass(scene,camera));bloomPass=new THREE.UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight),.6,.4,.85);composer.addPass(bloomPass);}

function setupEvents(){
    addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);composer.setSize(innerWidth,innerHeight);});
    document.getElementById('btnCake').addEventListener('click',()=>switchMode('cake'));
    document.getElementById('btnScatter').addEventListener('click',()=>switchMode('scatter'));
    document.getElementById('btnHeart').addEventListener('click',()=>switchMode('heart'));
    document.getElementById('btnCandle').addEventListener('click',toggleCandles);
}

function switchMode(mode){
    if(currentMode===mode)return;
    currentMode=mode;
    document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
    document.getElementById(mode==='cake'?'btnCake':mode==='scatter'?'btnScatter':'btnHeart').classList.add('active');
    allObjects.forEach(o=>{if(mode==='cake')o.currentTarget.copy(o.cakePos);else if(mode==='scatter')o.currentTarget.copy(o.scatterPos);else o.currentTarget.copy(o.heartPos);});

    // èœ¡çƒ›åªåœ¨cakeæ¨¡å¼æ˜¾ç¤º
    if(candleGroup){
        candleGroup.visible = (mode==='cake');
    }

    // èƒŒæ™¯éŸ³ä¹ï¼šä»…è›‹ç³•æ¨¡å¼æ’­æ”¾
    if(mode==='cake') startBirthdayMusic();
    else stopBirthdayMusic();

    // æ•£å¼€æ¨¡å¼ï¼šå¯åŠ¨æ°”çƒã€è‡ªåŠ¨æ—‹è½¬ã€ç…§ç‰‡æµ®åŠ¨
    if(mode==='scatter'){
        startBalloons();
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.2;
        startPhotoFloat();
    } else {
        stopBalloons();
        controls.autoRotate = false;
        stopPhotoFloat();
    }
}

function toggleCandles(){
    candlesOn=!candlesOn;
    const b=document.getElementById('btnCandle');
    b.textContent=candlesOn?'ğŸ•¯ï¸ å¹èœ¡çƒ›':'ğŸ”¥ ç‚¹èœ¡çƒ›';
    b.classList.toggle('active',!candlesOn);
}

function animateCake(){
    requestAnimationFrame(animateCake);
    const t=clock.getElapsedTime();
    for(const o of allObjects){const m=o.mesh;m.position.lerp(o.currentTarget,transitionSpeed);m.position.y+=Math.sin(t*.8+m.position.x*1.2)*.003;m.position.x+=Math.cos(t*.5+m.position.z*.8)*.002;m.rotation.x+=o.rs.x;m.rotation.y+=o.rs.y;m.rotation.z+=o.rs.z;if(o.lt===4)m.material.emissiveIntensity=.2+.15*Math.sin(t*2.5+m.position.y*3);}
    for(const f of flameParticles){const to=candlesOn?.85:0;f.mesh.material.opacity+=(to-f.mesh.material.opacity)*.05;if(candlesOn){const tt=t*f.sp+f.of;f.mesh.position.x=f.bx+Math.sin(tt*3)*.06;f.mesh.position.y=f.by+(Math.sin(tt*2)*.5+.5)*f.mh;f.mesh.position.z=f.bz+Math.cos(tt*2.5)*.06;f.mesh.scale.setScalar(.7+Math.sin(tt*4)*.3);}}
    ambientGroup.children.forEach(p=>{const d=p.userData;p.position.y=d.by+Math.sin(t*d.sp+d.of)*.8;p.material.opacity=.2+.3*Math.sin(t*d.sp*2+d.of);});
    if(candleGroup&&candleGroup.visible){candleGroup.children.forEach(ch=>{if(ch.isPointLight){const tg=candlesOn?.6:0;ch.intensity+=(tg-ch.intensity)*.05;if(candlesOn)ch.intensity+=Math.sin(t*8+ch.position.x*5)*.15;}});}
    controls.update();composer.render();
}

// ================================================================
//  ç…§ç‰‡æµ®åŠ¨ç³»ç»Ÿ
// ================================================================
const PHOTO_URLS = [
    'https://cdn.shopify.com/s/files/1/0703/6289/0421/files/66d54c0e5915eb9a503054cfb0883ee5.jpg?v=1770741966',
    'https://cdn.shopify.com/s/files/1/0703/6289/0421/files/6ff254589591d0fed817fbf6f3ec1f1d.jpg?v=1770741965',
];
let photoActive = false, photoSpawnTimer = null, photoFadeTimer = null, photoIndex = 0;

function startPhotoFloat(){
    if(photoActive) return;
    photoActive = true;
    document.getElementById('photo-layer').classList.add('active');
    photoIndex = 0;
    // é¦–å¼ å»¶è¿Ÿ 3 ç§’å‡ºç°
    photoSpawnTimer = setTimeout(spawnPhoto, 3000);
}

function stopPhotoFloat(){
    photoActive = false;
    clearTimeout(photoSpawnTimer);
    clearTimeout(photoFadeTimer);
    const layer = document.getElementById('photo-layer');
    layer.classList.remove('active');
    layer.innerHTML = '';
}

function spawnPhoto(){
    if(!photoActive) return;
    const layer = document.getElementById('photo-layer');

    // ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€å¼ ç…§ç‰‡ï¼šå…ˆæ¸…ç©º
    layer.innerHTML = '';

    const url = PHOTO_URLS[photoIndex % PHOTO_URLS.length];
    photoIndex++;

    const size = 70 + Math.random()*20;
    const el = document.createElement('div');
    el.className = 'photo-floater';
    el.style.width = size + 'px';
    el.style.height = size + 'px';

    const img = document.createElement('img');
    img.src = url;
    img.alt = 'photo';
    el.appendChild(img);

    // éšæœºå‡ºç°åœ¨å±å¹•ä»»æ„ä½ç½®ï¼ˆç•™è¶³è¾¹è·ï¼Œé¿å…é®æŒ¡æ ‡é¢˜å’ŒæŒ‰é’®ï¼‰
    const px = 100 + Math.random() * (innerWidth - size - 200);
    const py = 100 + Math.random() * (innerHeight - size - 200);
    el.style.left = px + 'px';
    el.style.top = py + 'px';

    el.addEventListener('click', (e)=>{
        e.stopPropagation();
        openPhotoOverlay(url);
    });

    layer.appendChild(el);

    // ä¸‹ä¸€å¸§æ·¡å…¥
    requestAnimationFrame(()=>{ requestAnimationFrame(()=> el.classList.add('visible')); });

    // æ˜¾ç¤º 5 ç§’åæ·¡å‡º
    photoFadeTimer = setTimeout(()=>{
        if(!photoActive){ el.remove(); return; }
        el.classList.remove('visible');
        el.classList.add('fade-out');
        // æ·¡å‡ºå®Œæˆåç§»é™¤ï¼Œé—´éš” 2~4 ç§’å†å‡ºç°ä¸‹ä¸€å¼ 
        setTimeout(()=>{
            el.remove();
            if(photoActive){
                photoSpawnTimer = setTimeout(spawnPhoto, 2000 + Math.random()*2000);
            }
        }, 1300);
    }, 5000);
}

function openPhotoOverlay(url){
    const overlay = document.getElementById('photo-overlay');
    const img = document.getElementById('photo-overlay-img');
    img.src = url;
    overlay.classList.add('show');
}

function closePhotoOverlay(){
    const overlay = document.getElementById('photo-overlay');
    overlay.classList.remove('show');
}

// ================================================================
//  ç”Ÿæ—¥å¿«ä¹èƒŒæ™¯éŸ³ä¹ (Web Audio API åˆæˆ)
// ================================================================
let bdayCtx = null, bdayGain = null, bdayPlaying = false, bdayTimeout = null, bdayWantPlay = false;

// æå‰åˆ›å»º AudioContextï¼Œå¹¶åœ¨ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶ resume
function ensureBdayCtx(){
    if(!bdayCtx){
        try{
            bdayCtx = new (window.AudioContext || window.webkitAudioContext)();
        }catch(e){ return; }
    }
    if(bdayCtx.state === 'suspended'){
        bdayCtx.resume().catch(()=>{});
    }
}

// é¡µé¢ä»»ä½•ç‚¹å‡»/è§¦æ‘¸éƒ½å°è¯•å”¤é†’ AudioContext å¹¶è¡¥æ’­éŸ³ä¹
function onUserGesture(){
    ensureBdayCtx();
    if(bdayWantPlay && !bdayPlaying && bdayCtx && bdayCtx.state === 'running'){
        actuallyStartMusic();
    }
}
document.addEventListener('click', onUserGesture, {once:false});
document.addEventListener('touchstart', onUserGesture, {once:false});

function startBirthdayMusic(){
    bdayWantPlay = true;
    if(bdayPlaying) return;
    ensureBdayCtx();
    if(!bdayCtx) return;
    // å¦‚æœ context å·²ç» runningï¼Œç«‹å³æ’­æ”¾ï¼›å¦åˆ™ç­‰ç”¨æˆ·äº¤äº’å”¤é†’
    if(bdayCtx.state === 'running'){
        actuallyStartMusic();
    }
    // suspended æ—¶ onUserGesture ä¼šè‡ªåŠ¨è¡¥æ’­
}

function actuallyStartMusic(){
    if(bdayPlaying) return;
    bdayPlaying = true;
    if(!bdayGain){
        bdayGain = bdayCtx.createGain();
        bdayGain.connect(bdayCtx.destination);
    }
    bdayGain.gain.setValueAtTime(0.35, bdayCtx.currentTime);
    playBirthdayLoop();
}

function stopBirthdayMusic(){
    bdayWantPlay = false;
    bdayPlaying = false;
    clearTimeout(bdayTimeout);
    if(bdayGain && bdayCtx){
        try{
            bdayGain.gain.cancelScheduledValues(bdayCtx.currentTime);
            bdayGain.gain.setValueAtTime(bdayGain.gain.value, bdayCtx.currentTime);
            bdayGain.gain.linearRampToValueAtTime(0, bdayCtx.currentTime + 0.3);
        }catch(e){}
    }
    // ä¸å…³é—­ contextï¼Œç•™ç€å¤ç”¨
}

function playBirthdayLoop(){
    if(!bdayPlaying || !bdayWantPlay || !bdayCtx || bdayCtx.state !== 'running') return;

    // ç”Ÿæ—¥å¿«ä¹æ­Œ - éŸ³ç¬¦: [é¢‘ç‡Hz, æ—¶é•¿ç§’]
    // C4=262, D4=294, E4=330, F4=349, G4=392, A4=440, B4=494, C5=523, Bb4=466
    const C4=262, D4=294, E4=330, F4=349, G4=392, A4=440, Bb4=466, C5=523;
    const notes = [
        // Happy birthday to you
        [C4,.3],[C4,.15],[D4,.45],[C4,.45],[F4,.45],[E4,.9],
        // Happy birthday to you
        [C4,.3],[C4,.15],[D4,.45],[C4,.45],[G4,.45],[F4,.9],
        // Happy birthday dear 77
        [C4,.3],[C4,.15],[C5,.45],[A4,.45],[F4,.45],[E4,.35],[D4,.55],
        // Happy birthday to you
        [Bb4,.3],[Bb4,.15],[A4,.45],[F4,.45],[G4,.45],[F4,.9],
    ];

    let t = bdayCtx.currentTime + 0.1;
    const tempo = 1.15; // ç¨æ…¢èŠ‚å¥ï¼Œæ¸©é¦¨æ„Ÿ

    for(const [freq, dur] of notes){
        // ä¸»éŸ³ - æŸ”å’Œæ­£å¼¦æ³¢
        const osc = bdayCtx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = freq;

        // æ³›éŸ³ - æ›´ä¸°å¯ŒéŸ³è‰²
        const osc2 = bdayCtx.createOscillator();
        osc2.type = 'triangle';
        osc2.frequency.value = freq * 2;

        const g = bdayCtx.createGain();
        const realDur = dur * tempo;
        g.gain.setValueAtTime(0.001, t);
        g.gain.linearRampToValueAtTime(0.5, t + 0.04);
        g.gain.setValueAtTime(0.5, t + realDur * 0.6);
        g.gain.exponentialRampToValueAtTime(0.001, t + realDur);

        const g2 = bdayCtx.createGain();
        g2.gain.setValueAtTime(0.001, t);
        g2.gain.linearRampToValueAtTime(0.08, t + 0.04);
        g2.gain.exponentialRampToValueAtTime(0.001, t + realDur);

        osc.connect(g); g.connect(bdayGain);
        osc2.connect(g2); g2.connect(bdayGain);

        osc.start(t); osc.stop(t + realDur + 0.05);
        osc2.start(t); osc2.stop(t + realDur + 0.05);

        t += realDur;
    }

    // æ•´é¦–æ­Œæ’­æ”¾å®Œåï¼Œé—´éš” 2 ç§’å¾ªç¯
    const totalDur = (t - bdayCtx.currentTime) * 1000 + 2000;
    bdayTimeout = setTimeout(()=>{
        if(bdayWantPlay && bdayPlaying) playBirthdayLoop();
    }, totalDur);
}
</script>
</body>
</html>

